# å¤šå¯†é’¥è½®è¯¢ç³»ç»Ÿ - å®Œæ•´æŒ‡å—

## æ¦‚è¿°

å¤šå¯†é’¥è½®è¯¢ï¼ˆMulti-Key Rotationï¼‰æ˜¯ Claude Code Nexus çš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€ï¼Œå…è®¸ä½ é…ç½®å¤šä¸ªåç«¯ API å¯†é’¥ï¼Œå®ç°ï¼š

- âš–ï¸ **è´Ÿè½½å‡è¡¡**: åœ¨å¤šä¸ªå¯†é’¥ä¹‹é—´è‡ªåŠ¨åˆ†é…è¯·æ±‚
- ğŸ”„ **æ•…éšœè½¬ç§»**: æŸä¸ªå¯†é’¥å¤±è´¥æ—¶è‡ªåŠ¨åˆ‡æ¢
- ğŸ“Š **ç»Ÿè®¡è¿½è¸ª**: è¯¦ç»†çš„ä½¿ç”¨ç»Ÿè®¡å’Œå¥åº·æ£€æŸ¥
- ğŸ¯ **çµæ´»æ§åˆ¶**: é€šè¿‡ä¼˜å…ˆçº§å’Œæƒé‡ç²¾ç»†æ§åˆ¶æµé‡

## æ¶æ„è®¾è®¡

### æ•°æ®æ¨¡å‹

æ¯ä¸ª Provider Key åŒ…å«ä»¥ä¸‹å­—æ®µï¼š

```typescript
{
  id: string;              // å”¯ä¸€æ ‡è¯†ç¬¦
  userId: string;          // æ‰€å±ç”¨æˆ·
  keyName: string;         // å¯†é’¥åç§°
  encryptedApiKey: string; // åŠ å¯†çš„ API Key
  baseUrl: string;         // API æœåŠ¡åœ°å€
  priority: number;        // ä¼˜å…ˆçº§ (0-100)
  weight: number;          // æƒé‡ (1-100)
  enabled: boolean;        // æ˜¯å¦å¯ç”¨
  failureCount: number;    // å¤±è´¥æ¬¡æ•°
  lastUsedAt: Date;        // æœ€åä½¿ç”¨æ—¶é—´
  totalRequests: number;   // æ€»è¯·æ±‚æ•°
  successfulRequests: number; // æˆåŠŸè¯·æ±‚æ•°
}
```

### å¯†é’¥é€‰æ‹©ç®—æ³•

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¼€å§‹: é€‰æ‹©ä¸‹ä¸€ä¸ª Provider Key      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è·å–æ‰€æœ‰å¯ç”¨çš„ Keys                 â”‚
â”‚ (enabled = true)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¿‡æ»¤å¥åº·çš„ Keys                     â”‚
â”‚ (failureCount < 5)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”œâ”€ æ²¡æœ‰å¥åº·çš„ Keys? â”€â”€â–º é‡ç½®æ‰€æœ‰å¤±è´¥è®¡æ•° â”€â”€â”
               â”‚                                           â”‚
               â–¼                                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚ é€‰æ‹©æœ€é«˜ä¼˜å…ˆçº§çš„ Keys               â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
               â”‚                                           â”‚
               â–¼                                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚ åœ¨ç›¸åŒä¼˜å…ˆçº§ä¸­é€‰æ‹©æœ€å°‘ä½¿ç”¨çš„        â”‚                  â”‚
â”‚ (æŒ‰ lastUsedAt æ’åº)                â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
               â”‚                                           â”‚
               â–¼                                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚ è§£å¯†å¹¶è¿”å›é€‰ä¸­çš„ Key                â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
                                                           â”‚
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
         è¿”å›ç¬¬ä¸€ä¸ª Key
```

## API æ¥å£

### 1. è·å–æ‰€æœ‰å¯†é’¥

**ç«¯ç‚¹**: `GET /api/keys`

**å“åº”**:
```json
{
  "keys": [
    {
      "id": "key_123",
      "keyName": "Primary API Key",
      "baseUrl": "https://api.nekro.ai/v1",
      "priority": 90,
      "weight": 10,
      "enabled": true,
      "failureCount": 0,
      "lastUsedAt": "2025-01-20T10:30:00Z",
      "totalRequests": 1250,
      "successfulRequests": 1245,
      "createdAt": "2025-01-15T08:00:00Z",
      "updatedAt": "2025-01-20T10:30:00Z"
    }
  ]
}
```

### 2. åˆ›å»ºå¯†é’¥

**ç«¯ç‚¹**: `POST /api/keys`

**è¯·æ±‚ä½“**:
```json
{
  "keyName": "Backup API Key",
  "apiKey": "sk-your-api-key-here",
  "baseUrl": "https://api.openai.com/v1",
  "priority": 50,
  "weight": 5,
  "enabled": true
}
```

**å“åº”**:
```json
{
  "id": "key_456",
  "message": "Key created successfully"
}
```

### 3. æ›´æ–°å¯†é’¥

**ç«¯ç‚¹**: `PUT /api/keys/{keyId}`

**è¯·æ±‚ä½“**:
```json
{
  "keyName": "Updated Name",
  "priority": 80,
  "enabled": false
}
```

**æ³¨æ„**: 
- `apiKey` å­—æ®µå¯é€‰ï¼Œç•™ç©ºåˆ™ä¸æ›´æ–°
- åªèƒ½æ›´æ–°è‡ªå·±çš„å¯†é’¥

### 4. åˆ é™¤å¯†é’¥

**ç«¯ç‚¹**: `DELETE /api/keys/{keyId}`

**å“åº”**:
```json
{
  "message": "Key deleted successfully"
}
```

### 5. è·å–å¯†é’¥ç»Ÿè®¡

**ç«¯ç‚¹**: `GET /api/keys/{keyId}/stats`

**å“åº”**:
```json
{
  "totalRequests": 1250,
  "successfulRequests": 1245,
  "failureRate": 0.4
}
```

## ä½¿ç”¨åœºæ™¯

### åœºæ™¯ 1: åŸºç¡€è´Ÿè½½å‡è¡¡

**é…ç½®**:
```
Key A: priority=100, weight=10, baseUrl=service-a.com
Key B: priority=100, weight=10, baseUrl=service-b.com
```

**æ•ˆæœ**: è¯·æ±‚åœ¨ä¸¤ä¸ªå¯†é’¥ä¹‹é—´å‡åŒ€åˆ†é…

### åœºæ™¯ 2: ä¸»å¤‡æ¨¡å¼

**é…ç½®**:
```
Primary: priority=100, weight=10, baseUrl=primary-service.com
Backup:  priority=50,  weight=10, baseUrl=backup-service.com
```

**æ•ˆæœ**: 
- æ­£å¸¸æƒ…å†µä¸‹ä½¿ç”¨ Primary
- Primary å¤±è´¥ 5 æ¬¡åè‡ªåŠ¨åˆ‡æ¢åˆ° Backup

### åœºæ™¯ 3: å¤šå±‚é™çº§

**é…ç½®**:
```
Tier 1: priority=100, weight=10 (é«˜çº§æœåŠ¡)
Tier 2: priority=80,  weight=10 (æ ‡å‡†æœåŠ¡)
Tier 3: priority=50,  weight=10 (å¤‡ç”¨æœåŠ¡)
```

**æ•ˆæœ**: æŒ‰ä¼˜å…ˆçº§ä¾æ¬¡é™çº§

### åœºæ™¯ 4: åŠ æƒæµé‡åˆ†é…

**é…ç½®**:
```
Key A: priority=100, weight=7  (70% æµé‡)
Key B: priority=100, weight=3  (30% æµé‡)
```

**æ•ˆæœ**: æŒ‰æƒé‡æ¯”ä¾‹åˆ†é…è¯·æ±‚

## ç›‘æ§å’Œç»´æŠ¤

### å…³é”®æŒ‡æ ‡

åœ¨å¯†é’¥ç®¡ç†é¡µé¢ç›‘æ§ï¼š

1. **æˆåŠŸç‡**: `successfulRequests / totalRequests * 100%`
2. **æœ€åä½¿ç”¨æ—¶é—´**: ç¡®è®¤å¯†é’¥åœ¨æ­£å¸¸è½®æ¢
3. **å¤±è´¥æ¬¡æ•°**: > 3 éœ€è¦å…³æ³¨ï¼Œ= 5 ä¼šè¢«æš‚æ—¶è·³è¿‡

### å¥åº·æ£€æŸ¥ç­–ç•¥

ç³»ç»Ÿè‡ªåŠ¨è¿›è¡Œå¥åº·æ£€æŸ¥ï¼š

```typescript
// å¯†é’¥è¢«è®¤ä¸ºä¸å¥åº·çš„æ¡ä»¶
if (key.failureCount >= 5) {
  // è·³è¿‡æ­¤å¯†é’¥
}

// æˆåŠŸåé‡ç½®
if (requestSuccess) {
  key.failureCount = 0;
}

// å¤±è´¥åç´¯åŠ 
if (requestFailed) {
  key.failureCount += 1;
}
```

### æœ€ä½³å®è·µ

1. **è‡³å°‘é…ç½® 2 ä¸ªå¯†é’¥**: å®ç°åŸºæœ¬çš„é«˜å¯ç”¨
2. **è®¾ç½®åˆç†çš„ä¼˜å…ˆçº§**: é¿å…æ‰€æœ‰å¯†é’¥åŒä¼˜å…ˆçº§
3. **å®šæœŸæ£€æŸ¥ç»Ÿè®¡**: æ¯å‘¨æŸ¥çœ‹ä¸€æ¬¡æˆåŠŸç‡
4. **åŠæ—¶æ›¿æ¢å¼‚å¸¸å¯†é’¥**: å¤±è´¥ç‡ > 5% éœ€è¦è°ƒæŸ¥
5. **ä¿ç•™å¤‡ç”¨å¯†é’¥**: ä½ä¼˜å…ˆçº§çš„å¤‡ç”¨å¯†é’¥å¾ˆé‡è¦

## æ•…éšœæ’é™¤

### é—®é¢˜ 1: æŸä¸ªå¯†é’¥ä¸€ç›´ä¸è¢«ä½¿ç”¨

**åŸå› **: 
- ä¼˜å…ˆçº§è®¾ç½®è¿‡ä½
- è¢«æ ‡è®°ä¸ºä¸å¥åº·ï¼ˆå¤±è´¥æ¬¡æ•° >= 5ï¼‰

**è§£å†³**:
```
1. æ£€æŸ¥ä¼˜å…ˆçº§è®¾ç½®
2. æŸ¥çœ‹å¤±è´¥æ¬¡æ•°ï¼Œå¦‚æœ >= 5ï¼Œä¸´æ—¶ç¦ç”¨å…¶ä»–å¯†é’¥æµ‹è¯•
3. æ‰‹åŠ¨é‡ç½®å¤±è´¥è®¡æ•°ï¼ˆç¼–è¾‘å¯†é’¥ï¼Œä¸ä¿®æ”¹ä»»ä½•å­—æ®µï¼Œç›´æ¥ä¿å­˜ï¼‰
```

### é—®é¢˜ 2: æ‰€æœ‰å¯†é’¥éƒ½å¤±è´¥

**ç°è±¡**: è¯·æ±‚è¿”å› 500 é”™è¯¯

**æ’æŸ¥æ­¥éª¤**:
```
1. æ£€æŸ¥ç½‘å…³æ—¥å¿— (/logs)
2. éªŒè¯æ¯ä¸ªå¯†é’¥çš„ API Key æ˜¯å¦æœ‰æ•ˆ
3. æ£€æŸ¥ baseUrl æ˜¯å¦æ­£ç¡®
4. æµ‹è¯•åç«¯æœåŠ¡æ˜¯å¦åœ¨çº¿
```

### é—®é¢˜ 3: è´Ÿè½½ä¸å‡è¡¡

**åŸå› **: 
- æƒé‡è®¾ç½®ä¸åˆç†
- æœ€åä½¿ç”¨æ—¶é—´å·®å¼‚å¤§

**è§£å†³**:
```
1. è°ƒæ•´æƒé‡æ¯”ä¾‹
2. ç¡®ä¿æ‰€æœ‰å¯†é’¥éƒ½æ˜¯å¯ç”¨çŠ¶æ€
3. ä¸´æ—¶ç¦ç”¨æŸäº›å¯†é’¥è§‚å¯Ÿæµé‡å˜åŒ–
```

## å®‰å…¨è€ƒè™‘

### åŠ å¯†å­˜å‚¨

æ‰€æœ‰ API Key åœ¨æ•°æ®åº“ä¸­åŠ å¯†å­˜å‚¨ï¼š

```typescript
// ä¿å­˜æ—¶
const encrypted = await encryptApiKey(plainKey, ENCRYPTION_KEY);

// ä½¿ç”¨æ—¶
const decrypted = await decryptApiKey(encrypted, ENCRYPTION_KEY);
```

### æƒé™æ§åˆ¶

- ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„å¯†é’¥
- API ç«¯ç‚¹æœ‰è®¤è¯ä¸­é—´ä»¶ä¿æŠ¤
- å¯†é’¥ä¸ä¼šåœ¨æ—¥å¿—ä¸­æ˜æ–‡æ˜¾ç¤º

### å®¡è®¡è¿½è¸ª

æ¯ä¸ªå¯†é’¥çš„ä½¿ç”¨éƒ½ä¼šè®°å½•ï¼š

- ä½¿ç”¨æ—¶é—´
- è¯·æ±‚ç»“æœ
- ç›¸å…³è”çš„ç½‘å…³æ—¥å¿—

## æ€§èƒ½ä¼˜åŒ–

### æ•°æ®åº“ç´¢å¼•

å…³é”®å­—æ®µå·²æ·»åŠ ç´¢å¼•ï¼š

```sql
CREATE INDEX provider_keys_user_id_idx ON provider_keys(user_id);
CREATE INDEX provider_keys_enabled_idx ON provider_keys(enabled);
```

### ç¼“å­˜ç­–ç•¥

å¯†é’¥é€‰æ‹©ç®—æ³•åœ¨å•æ¬¡è¯·æ±‚å†…å®Œæˆï¼Œæ— éœ€ç¼“å­˜ã€‚

### å¹¶å‘æ§åˆ¶

ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡ç¡®ä¿è®¡æ•°å™¨çš„å‡†ç¡®æ€§ï¼š

```typescript
await db.update(providerKeys)
  .set({ 
    totalRequests: providerKeys.totalRequests + 1 
  })
  .where(eq(providerKeys.id, keyId));
```

## é«˜çº§åŠŸèƒ½ï¼ˆæœªæ¥è®¡åˆ’ï¼‰

1. **é€Ÿç‡é™åˆ¶**: æŒ‰å¯†é’¥è®¾ç½® QPS é™åˆ¶
2. **å®šæ—¶ä»»åŠ¡**: è‡ªåŠ¨é‡ç½®å¤±è´¥è®¡æ•°
3. **å‘Šè­¦é€šçŸ¥**: å¤±è´¥ç‡è¿‡é«˜æ—¶å‘é€é€šçŸ¥
4. **A/B æµ‹è¯•**: çµæ´»çš„æµé‡åˆ†é…ç­–ç•¥
5. **åœ°ç†ä½ç½®**: æ ¹æ®ç”¨æˆ·ä½ç½®é€‰æ‹©å¯†é’¥

## ç¤ºä¾‹ä»£ç 

### ä½¿ç”¨ API ç®¡ç†å¯†é’¥

```typescript
// æ·»åŠ å¯†é’¥
async function addKey() {
  const response = await fetch('/api/keys', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    credentials: 'include',
    body: JSON.stringify({
      keyName: 'My API Key',
      apiKey: 'sk-...',
      baseUrl: 'https://api.example.com/v1',
      priority: 90,
      weight: 10,
      enabled: true,
    }),
  });
  
  const data = await response.json();
  console.log('Key created:', data.id);
}

// è·å–ç»Ÿè®¡
async function getStats(keyId: string) {
  const response = await fetch(`/api/keys/${keyId}/stats`, {
    credentials: 'include',
  });
  
  const stats = await response.json();
  console.log('Success rate:', 
    (stats.successfulRequests / stats.totalRequests * 100).toFixed(2) + '%'
  );
}
```

### æµ‹è¯•å¯†é’¥è½®æ¢

```bash
# å‘é€å¤šä¸ªè¯·æ±‚è§‚å¯Ÿå¯†é’¥ä½¿ç”¨æƒ…å†µ
for i in {1..10}; do
  curl -X POST https://your-domain.pages.dev/v1/messages \
    -H "Authorization: Bearer ak-your-nexus-key" \
    -H "Content-Type: application/json" \
    -d '{
      "model": "claude-3-5-sonnet-20241022",
      "messages": [{"role": "user", "content": "Hello"}],
      "max_tokens": 100
    }'
  sleep 1
done

# ç„¶ååœ¨ç½‘å…³æ—¥å¿—ä¸­æŸ¥çœ‹ä½¿ç”¨äº†å“ªäº›å¯†é’¥
```

## æ€»ç»“

å¤šå¯†é’¥è½®è¯¢ç³»ç»Ÿæä¾›äº†ä¼ä¸šçº§çš„é«˜å¯ç”¨å’Œè´Ÿè½½å‡è¡¡èƒ½åŠ›ï¼š

âœ… è‡ªåŠ¨æ•…éšœè½¬ç§»  
âœ… çµæ´»çš„æµé‡æ§åˆ¶  
âœ… è¯¦ç»†çš„ç»Ÿè®¡è¿½è¸ª  
âœ… ç®€å•æ˜“ç”¨çš„ç®¡ç†ç•Œé¢  

åˆç†é…ç½®å’Œç›‘æ§å¤šä¸ªå¯†é’¥ï¼Œå¯ä»¥æ˜¾è‘—æé«˜æœåŠ¡çš„ç¨³å®šæ€§å’Œå¯ç”¨æ€§ã€‚

---

**ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-01-20
